<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ±äº¬ä¹‹æ—…</title>

  <!-- Google Font for time digits -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;600&display=swap">

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              DEFAULT: '#38bdf8',
              dark: '#0ea5e9'
            },
            accent: '#facc15',
            timeline: '#60a5fa',
            noteOrange: '#f97316'
          },
          borderRadius: {
            card: '18px',
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: #e5f2ff;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    /* è®“å‚™è¨»é¡¯ç¤ºæ™‚æ”¯æ´æ›è¡Œ */
    .note-multiline {
      white-space: pre-line;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center">
  <div id="app"
       class="relative w-full max-w-sm h-[780px] bg-white rounded-3xl shadow-xl flex flex-col overflow-hidden border border-slate-200">

    <!-- Headerï¼šæ±äº¬ä¹‹æ—… + icon tabs -->
    <header class="relative">
      <div class="px-4 pt-5 pb-4 bg-gradient-to-r from-primary to-primary-dark text-white rounded-t-3xl">
        <div class="flex items-start justify-between">
          <!-- å·¦é‚Šï¼šæ¨™é¡Œ -->
          <div class="space-y-1">
            <div class="flex items-center gap-2">
              <span class="text-2xl">âœˆï¸</span>
              <div>
                <p class="text-sm font-bold tracking-wide">æ±äº¬ä¹‹æ—…</p>
                <p class="text-xl font-extrabold leading-tight">Tokyo</p>
              </div>
            </div>
            <p class="text-[11px] tracking-[0.18em] uppercase text-white/80 font-medium">
              Dec 28 â€“ Jan 03, 2026
            </p>
          </div>

          <!-- å³é‚Šï¼šé ‚éƒ¨ icon tabs -->
          <div class="flex flex-col items-end gap-2">
            <!-- åŒ¯ç‡å°å­— -->
            <div class="text-[10px] text-white/90 text-right leading-snug">
              <p>{{ todayString }}</p>
              <p>1 JPY â‰ˆ {{ jpyRate }} HKD</p>
            </div>

            <!-- è† å›Š tab -->
            <div class="bg-white/10 rounded-2xl px-1 py-1 flex items-center gap-1 shadow-lg">
              <button
                class="w-9 h-9 rounded-xl flex items-center justify-center text-xs transition"
                :class="activeTab === 'schedule'
                  ? 'bg-white text-primary shadow-md'
                  : 'bg-transparent text-white/85'"
                @click="activeTab = 'schedule'"
              >
                <span class="text-lg">ğŸ“…</span>
              </button>
              <button
                class="w-9 h-9 rounded-xl flex items-center justify-center text-xs transition"
                :class="activeTab === 'expense'
                  ? 'bg-white text-primary shadow-md'
                  : 'bg-transparent text-white/85'"
                @click="activeTab = 'expense'"
              >
                <span class="text-lg">ğŸ’°</span>
              </button>
              <button
                class="w-9 h-9 rounded-xl flex items-center justify-center text-xs transition"
                :class="activeTab === 'todo'
                  ? 'bg-white text-primary shadow-md'
                  : 'bg-transparent text-white/85'"
                @click="activeTab = 'todo'"
              >
                <span class="text-lg">ğŸ“‹</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- é ‚éƒ¨æ”¯å‡ºçµ±è¨ˆï¼šåªåœ¨è¨˜å¸³é é¡¯ç¤º -->
      <div class="px-4 -mb-2" v-if="activeTab === 'expense'">
        <div class="mt-2 bg-white/95 rounded-2xl shadow-md border border-slate-100 text-xs overflow-hidden">
          <div class="px-3 py-2 border-b border-slate-100 flex items-baseline justify-between">
            <p class="text-[11px] text-slate-500 font-medium">ç¸½æ”¯å‡ºï¼ˆæ›ç®— HKDï¼‰</p>
            <p class="text-sm font-bold text-slate-900">
              {{ totalExpenseHKD.toFixed(2) }} HKD
            </p>
          </div>
          <div class="flex">
            <div class="flex-1 px-3 py-2 border-r border-slate-100">
              <p class="text-[11px] text-slate-500 font-medium">Kenneth å·²ä»˜</p>
              <p class="text-sm font-bold text-slate-900">
                {{ kennethTotalHKD.toFixed(2) }} HKD
              </p>
            </div>
            <div class="flex-1 px-3 py-2">
              <p class="text-[11px] text-slate-500 font-medium">Bianca å·²ä»˜</p>
              <p class="text-sm font-bold text-slate-900">
                {{ biancaTotalHKD.toFixed(2) }} HKD
              </p>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- å…§å®¹ -->
    <main class="flex-1 overflow-y-auto px-4 py-3 bg-slate-50">
      <!-- è¡Œç¨‹è¡¨ Tab -->
      <section v-if="activeTab === 'schedule'" class="space-y-3">
        <h2 class="text-sm font-semibold text-slate-700 mb-1">è¡Œç¨‹è¡¨</h2>

        <!-- æ©«å‘æ—¥æ›† -->
        <div class="mb-3">
          <p class="text-[11px] text-slate-500 mb-1 font-medium">
            2025-12-28 ï½ 2026-01-03ï¼ˆæ±äº¬ï¼‰
          </p>
          <div class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
            <button
              v-for="(day, index) in tripDays"
              :key="day.dateKey"
              class="flex-none w-16 h-18 rounded-2xl text-center text-xs flex flex-col items-center justify-center transition border font-medium"
              :class="day.dateKey === selectedDate
                ? 'bg-white text-primary border-white shadow-md'
                : 'bg-primary/70 text-white border-primary/40'"
              @click="selectedDate = day.dateKey"
            >
              <span class="text-[11px] opacity-95">
                {{ day.label }}
              </span>
              <span class="text-sm font-bold mt-0.5">
                Day {{ index + 1 }}
              </span>
            </button>
          </div>
        </div>

        <!-- æ¯æ—¥ header + å¤©æ°£åˆ— -->
        <div class="bg-white rounded-card shadow-md p-3 border border-slate-100 mb-3">
          <div class="flex items-center justify-between">
            <div class="w-2/3 pr-2">
              <p class="text-base font-bold text-slate-900 leading-tight">
                {{ dayHeaderTitle }}
              </p>
              <input
                :value="dayNotes[selectedDate] || ''"
                @input="updateDayDescription($event.target.value)"
                type="text"
                class="mt-0.5 w-full text-[11px] font-normal text-slate-600 bg-transparent border-b border-slate-200 focus:outline-none focus:border-primary/60"
                placeholder="è¼¸å…¥é€™ä¸€å¤©çš„æè¿°ï¼Œä¾‹å¦‚ï¼šæ± è¢‹ï¼†æ–°å®¿"
              />
            </div>
            <div class="flex items-center gap-2 text-xs">
              <span class="text-2xl" v-if="currentWeather.icon">
                {{ currentWeather.icon }}
              </span>
              <div class="text-right">
                <p class="text-sm font-bold text-slate-900" v-if="currentWeather.tempHigh || currentWeather.tempLow">
                  <span v-if="currentWeather.tempHigh">{{ currentWeather.tempHigh }}</span>
                  <span v-if="currentWeather.tempHigh && currentWeather.tempLow"> / </span>
                  <span v-if="currentWeather.tempLow">{{ currentWeather.tempLow }}</span>
                </p>
                <p class="text-[11px] text-slate-400 font-normal" v-if="currentWeather.location">
                  {{ currentWeather.location }}
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- timeline + è¡Œç¨‹å¡ -->
        <div v-if="sortedSchedulesForSelected.length"
             class="relative pl-6 space-y-4">
          <div class="absolute left-3 top-0 bottom-0 w-[2px] bg-gradient-to-b from-primary/50 to-primary/5 pointer-events-none"></div>

          <div v-for="(item, index) in sortedSchedulesForSelected" :key="item.id"
               class="relative flex items-stretch gap-3 rounded-3xl bg-white shadow-md px-3 py-3 border border-slate-100">
            <div class="absolute -left-[7px] top-7 w-3 h-3 rounded-full border-2 border-white bg-timeline shadow-sm"></div>

            <!-- æ™‚é–“æ–¹å¡Š -->
            <div class="w-22 flex flex-col items-center gap-2">
              <div class="w-20 text-center rounded-2xl bg-white border border-slate-200 px-3 py-2 flex flex-col items-center justify-center shadow-sm">
                <p class="text-[11px] text-slate-400 mb-1 font-medium">
                  {{ timePeriodLabel(item.time) }}
                </p>
                <p class="text-2xl font-semibold text-slate-900 leading-tight tracking-wide font-[Poppins]">
                  {{ formattedTime(item.time) }}
                </p>
              </div>
            </div>

            <!-- è¡Œç¨‹å¡ -->
            <div class="flex-1">
              <div class="cursor-pointer" @click="openEditSchedule(item)">
                <p class="text-base font-semibold text-slate-900 mb-1 truncate" v-if="item.location">
                  {{ item.location }}
                </p>
                <p class="text-base font-semibold text-slate-900 mb-1 truncate" v-else>
                  æœªå‘½ååœ°é»
                </p>

                <div v-if="item.note" class="mt-0.5 flex items-start gap-1">
                  <span
                    class="mt-[3px] inline-flex items-center justify-center w-3.5 h-3.5 rounded-full border border-noteOrange text-[9px] text-noteOrange font-semibold leading-none">
                    i
                  </span>
                  <!-- é¡¯ç¤ºæ™‚æ”¯æ´æ›è¡Œ -->
                  <p class="text-[11px] text-noteOrange leading-snug note-multiline">
                    {{ item.note }}
                  </p>
                </div>

                <!-- åˆ†é¡ + åœ°åœ– åŒä¸€è¡Œ -->
                <div class="mt-2 flex items-center gap-2">
                  <select
                    v-model="item.category"
                    @change.stop="updateScheduleCategory(item.id, item.category)"
                    class="text-[11px] px-2 py-1.5 rounded-2xl border border-slate-200 bg-white text-slate-600 focus:outline-none focus:ring-1 focus:ring-primary/40 appearance-none"
                  >
                    <option value="">æœªåˆ†é¡</option>
                    <option value="transport">ğŸš„ äº¤é€š</option>
                    <option value="sightseeing">â›©ï¸ æ™¯é»</option>
                    <option value="food">ğŸ¢ ç¾é£Ÿ</option>
                  </select>

                  <button
                    v-if="item.mapUrl"
                    class="inline-flex items-center gap-1 text-[10px] px-2 py-1 rounded-full bg-primary/5 text-primary border border-primary/20 font-medium"
                    @click.stop="openMapUrl(item.mapUrl)">
                    åœ°åœ–
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p v-else class="text-[11px] text-slate-400 text-center mt-4 font-normal">
          é€™ä¸€å¤©é‚„æ²’æœ‰è¡Œç¨‹ï¼ŒæŒ‰å³ä¸‹è§’ã€Œï¼‹ã€æ–°å¢ã€‚
        </p>
      </section>

      <!-- è¨˜å¸³ Tab -->
      <section v-if="activeTab === 'expense'" class="space-y-3">
        <div class="flex items-center justify-between mb-1">
          <h2 class="text-sm font-semibold text-slate-700">æ—…è¡Œè¨˜å¸³</h2>
        </div>

        <!-- è¨˜å¸³æ—¥æœŸæ©«å‘ç¯©é¸ -->
        <div class="mt-1">
          <p class="text-[11px] text-slate-500 mb-1 font-medium">
            æŒ‰æ—¥æœŸæŸ¥çœ‹æ”¯å‡ºï¼ˆå¯æ©«å‘æ»‘å‹•ï¼‰
          </p>
          <div class="flex gap-2 overflow-x-auto pb-1 hide-scrollbar">
            <!-- å…¨éƒ¨ -->
            <button
              class="flex-none px-3 h-8 rounded-2xl text-[11px] font-medium border transition"
              :class="expenseSelectedDate === ''
                ? 'bg-white text-primary border-primary shadow-sm'
                : 'bg-slate-100 text-slate-600 border-slate-200'"
              @click="expenseSelectedDate = ''"
            >
              å…¨éƒ¨
            </button>

            <!-- æ¯ä¸€å¤© -->
            <button
              v-for="(day, index) in tripDays"
              :key="'expense-' + day.dateKey"
              class="flex-none w-16 h-8 rounded-2xl text-center text-[11px] flex flex-col items-center justify-center transition border font-medium"
              :class="day.dateKey === expenseSelectedDate
                ? 'bg-white text-primary border-primary shadow-sm'
                : 'bg-slate-100 text-slate-600 border-slate-200'"
              @click="expenseSelectedDate = day.dateKey"
            >
              <span>{{ day.label }}</span>
              <span class="text-[10px]">Day {{ index + 1 }}</span>
            </button>
          </div>
        </div>

        <!-- æ–°å¢ / ç·¨è¼¯æ”¯å‡º -->
        <div class="bg-white rounded-card shadow-md p-3 border border-slate-100 space-y-2">
          <h3 class="text-xs font-semibold text-slate-600 mb-1">
            {{ editingExpenseIndex !== null ? 'ç·¨è¼¯æ”¯å‡º' : 'æ–°å¢æ”¯å‡º' }}
          </h3>
          <div class="flex gap-2">
            <input v-model.number="newExpense.amount" type="number" min="0" step="0.01"
                   placeholder="é‡‘é¡"
                   class="w-1/3 text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
            <select v-model="newExpense.currency"
                    class="w-1/4 text-xs px-2 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary/40">
              <option value="" disabled>å¹£åˆ¥</option>
              <option value="JPY">JPY</option>
              <option value="HKD">HKD</option>
            </select>
            <select v-model="newExpense.paidBy"
                    class="flex-1 text-xs px-2 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary/40">
              <option value="" disabled>èª°ä»˜éŒ¢</option>
              <option value="kenneth">Kenneth</option>
              <option value="bianca">Bianca</option>
            </select>
          </div>

          <!-- æ—¥æœŸ + é¡åˆ¥ åŒä¸€è¡Œ -->
          <div class="flex gap-2">
            <input
              v-model="newExpense.date"
              type="date"
              class="w-1/2 text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
            <select v-model="newExpense.category"
                    class="w-1/2 text-xs px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary/40">
              <option value="" disabled>é¡åˆ¥</option>
              <option>äº¤é€š</option>
              <option>é¤é£²</option>
              <option>ä½å®¿</option>
              <option>è³¼ç‰©</option>
              <option>é–€ç¥¨ / æ´»å‹•</option>
              <option>å…¶ä»–</option>
            </select>
          </div>

          <input v-model="newExpense.note" type="text" placeholder="å‚™è¨»ï¼ˆä¾‹å¦‚ï¼šæ™šé¤ã€åœ°éµã€ç¦®ç‰©ï¼‰"
                 class="w-full text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
          <button @click="addExpense"
                  class="w-full text-xs py-2 rounded-xl bg-primary text-white font-semibold hover:bg-primary-dark transition disabled:opacity-50"
                  :disabled="!canAddExpense">
            {{ editingExpenseIndex !== null ? 'æ›´æ–°æ”¯å‡º' : 'åŠ å…¥æ”¯å‡º' }}
          </button>
        </div>

        <!-- æ”¯å‡ºåˆ—è¡¨ -->
        <div v-if="filteredExpenses.length" class="space-y-2">
          <div v-for="(exp, index) in filteredExpenses" :key="index"
               class="bg-white rounded-card shadow-md p-3 flex items-start justify-between border border-slate-100 cursor-pointer"
               @click="startEditExpense(index)">
            <div class="flex-1 pr-2">
              <div class="flex items-center justify-between mb-0.5">
                <p class="text-xs font-semibold text-slate-800">
                  {{ exp.category || 'å…¶ä»–' }} Â·
                  <span v-if="exp.paidBy === 'kenneth'">Kenneth ä»˜</span>
                  <span v-else-if="exp.paidBy === 'bianca'">Bianca ä»˜</span>
                  <span v-else>æœªçŸ¥</span>
                </p>
                <p class="text-[11px] text-slate-400" v-if="exp.date">
                  {{ exp.date }}
                </p>
              </div>
              <p class="text-[11px] text-slate-600" v-if="exp.note">
                {{ exp.note }}
              </p>
              <p class="text-[11px] text-emerald-600 mt-1" v-if="exp.currency === 'JPY'">
                ç´„ {{ (exp.amount * jpyRate).toFixed(2) }} HKD
              </p>
            </div>
            <div class="text-right">
              <p class="text-sm font-semibold text-slate-900">
                {{ exp.amount.toFixed(0) }} {{ exp.currency }}
              </p>
              <button class="text-[10px] text-red-400 hover:text-red-500 mt-1"
                      @click.stop="removeExpense(index)">
                åˆªé™¤
              </button>
            </div>
          </div>
        </div>
        <p v-else class="text-[11px] text-slate-400 text-center mt-4">
          é‚„æœªæœ‰æ”¯å‡ºç´€éŒ„ï¼Œè©¦è©¦æ–°å¢ä¸€ç­†ã€‚
        </p>
      </section>

      <!-- æ¸…å–® Tab -->
      <section v-if="activeTab === 'todo'" class="space-y-3">
        <h2 class="text-sm font-semibold text-slate-700 mb-1">è³¼ç‰© / æ‰“åŒ…æ¸…å–®</h2>

        <div class="bg-white rounded-card shadow-md p-3 border border-slate-100 space-y-2">
          <div class="flex gap-2">
            <input v-model="newTodoText" type="text" placeholder="ä¾‹å¦‚ï¼šè­·ç…§ã€è½‰æ›æ’é ­ã€çµ¦å½¼æ­¤çš„å°ç¦®ç‰©"
                   class="flex-1 text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
            <button @click="addTodo"
                    class="text-xs px-3 py-2 rounded-xl bg-primary text-white font-semibold hover:bg-primary-dark transition disabled:opacity-50"
                    :disabled="!newTodoText">
              åŠ å…¥
            </button>
          </div>
        </div>

        <div v-if="todos.length" class="space-y-2">
          <div v-for="(todo, index) in todos" :key="index"
               class="bg-white rounded-card shadow-md p-2.5 border border-slate-100 flex items-center">
            <input type="checkbox" v-model="todo.done"
                   class="w-4 h-4 text-primary rounded border-slate-300 mr-2">
            <div class="flex-1">
              <p class="text-xs"
                 :class="todo.done ? 'line-through text-slate-400' : 'text-slate-800'">
                {{ todo.text }}
              </p>
            </div>
            <button class="text-[10px] text-red-400 hover:text-red-500 px-1"
                    @click="removeTodo(index)">
              åˆªé™¤
            </button>
          </div>
        </div>
        <p v-else class="text-[11px] text-slate-400 text-center mt-4">
          é‚„æ²’æœ‰æ¸…å–®é …ç›®ï¼Œå…ˆåŠ å¹¾æ¨£è¦å¸¶æˆ–è¦è²·çš„æ±è¥¿ã€‚
        </p>
      </section>
    </main>

    <!-- æµ®å‹• + æŒ‰éˆ•ï¼šåªåœ¨è¡Œç¨‹é  -->
    <button v-if="activeTab === 'schedule'"
            class="absolute bottom-4 right-5 w-12 h-12 rounded-full bg-accent text-white shadow-lg flex items-center justify-center text-2xl"
            @click="openNewSchedule">
      +
    </button>

    <!-- è¡Œç¨‹æ–°å¢ / ç·¨è¼¯å½ˆçª— -->
    <div v-if="showScheduleModal"
         class="absolute inset-0 bg-black/30 flex items-center justify-center z-20">
      <div class="w-[90%] bg-white rounded-2xl shadow-xl p-4 text-xs">
        <h3 class="text-sm font-semibold text-slate-800 mb-2">
          {{ editingSchedule && editingSchedule.id ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}
        </h3>
        <div class="space-y-2">
          <div class="flex gap-2">
            <div class="flex-1">
              <p class="text-[11px] text-slate-500 mb-1">æ—¥æœŸ</p>
              <input v-model="editingSchedule.date"
                     type="date"
                     class="w-full text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
            </div>
            <div class="w-24">
              <p class="text-[11px] text-slate-500 mb-1">æ™‚é–“</p>
              <input v-model="editingSchedule.time"
                     type="time"
                     class="w-full text-xs px-2 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
            </div>
          </div>

          <div>
            <p class="text-[11px] text-slate-500 mb-1">åœ°é»åç¨±</p>
            <input v-model="editingSchedule.location" type="text"
                   placeholder="ä¾‹å¦‚ï¼šæˆç”°æ©Ÿå ´ã€æ·ºè‰å¯º"
                   class="w-full text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
          </div>

          <div>
            <p class="text-[11px] text-slate-500 mb-1">Google Maps é€£çµï¼ˆå¯é¸ï¼‰</p>
            <input v-model="editingSchedule.mapUrl" type="text"
                   placeholder="è²¼ä¸Š Google Maps åˆ†äº«é€£çµ"
                   class="w-full text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40">
          </div>

          <div>
            <p class="text-[11px] text-slate-500 mb-1">å‚™è¨»</p>
            <!-- é€™è£¡æœ¬ä¾†å°±æ˜¯ textareaï¼Œä¿ç•™ -->
            <textarea v-model="editingSchedule.note" rows="3"
                      class="w-full text-xs px-3 py-2 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/40"
                      placeholder="èˆªç­ç·¨è™Ÿã€äº¤é€šæ–¹å¼ç­‰ç­‰ï¼ˆå¯æ›è¡Œï¼‰"></textarea>
          </div>

          <div>
            <p class="text-[11px] text-slate-500 mb-1">é¡åˆ¥ï¼ˆå¯é¸ï¼‰</p>
            <select
              v-model="editingSchedule.category"
              class="w-full text-[11px] px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-primary/40"
            >
              <option value="">æœªåˆ†é¡</option>
              <option value="transport">ğŸš„ äº¤é€š</option>
              <option value="sightseeing">â›©ï¸ æ™¯é»</option>
              <option value="food">ğŸ¢ ç¾é£Ÿ</option>
            </select>
          </div>

          <div class="flex items-center justify-between pt-2">
            <button class="text-[11px] text-slate-500 px-2 py-1"
                    @click="closeScheduleModal">
              å–æ¶ˆ
            </button>
            <div class="flex items-center gap-2">
              <button v-if="editingSchedule && editingSchedule.id"
                      class="text-[11px] text-red-500 px-3 py-1 rounded-xl border border-red-200"
                      @click="deleteSchedule(editingSchedule.id)">
                åˆªé™¤
              </button>
              <button class="text-[11px] text-white px-4 py-1.5 rounded-xl bg-primary hover:bg-primary-dark font-semibold disabled:opacity-50"
                      :disabled="!editingSchedule.date"
                      @click="saveSchedule">
                å„²å­˜
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Vue App + Firebase -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBiGEnmF_0avwzA_9oc18P84scoePCDb-o",
      authDomain: "tokyo-trip-3bcc4.firebaseapp.com",
      projectId: "tokyo-trip-3bcc4",
      storageBucket: "tokyo-trip-3bcc4.firebasestorage.app",
      messagingSenderId: "850356667552",
      appId: "1:850356667552:web:b5a7af2976dfbaebbf35c5"
    };

    const firebaseApp = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const tripDocRef = db.collection('trips').doc('tokyo-trip');
    const expensesColRef = tripDocRef.collection('expenses');
    const schedulesColRef = tripDocRef.collection('schedules');
    const todosColRef = tripDocRef.collection('todos');
    const dayNotesColRef = tripDocRef.collection('dayNotes');

    const { createApp } = Vue;

    createApp({
      data() {
        return {
          activeTab: 'schedule',
          jpyRate: 0.053,
          tripDays: [
            { dateKey: '2025-12-28', label: '12/28', weekday: 'æ—¥' },
            { dateKey: '2025-12-29', label: '12/29', weekday: 'ä¸€' },
            { dateKey: '2025-12-30', label: '12/30', weekday: 'äºŒ' },
            { dateKey: '2025-12-31', label: '12/31', weekday: 'ä¸‰' },
            { dateKey: '2026-01-01', label: '01/01', weekday: 'å››' },
            { dateKey: '2026-01-02', label: '01/02', weekday: 'äº”' },
            { dateKey: '2026-01-03', label: '01/03', weekday: 'å…­' },
          ],
          weatherByDate: {
            '2025-12-28': { icon: 'ğŸŒ¤ï¸', location: 'æ±äº¬', tempHigh: '10Â°', tempLow: '3Â°' },
            '2025-12-29': { icon: 'ğŸŒ§ï¸', location: 'æ±äº¬', tempHigh: '11Â°', tempLow: '4Â°' },
            '2025-12-30': { icon: 'â˜ï¸', location: 'æ±äº¬', tempHigh: '12Â°', tempLow: '4Â°' },
            '2025-12-31': { icon: 'ğŸŒ¤ï¸', location: 'æ±äº¬', tempHigh: '9Â°', tempLow: '3Â°' },
            '2026-01-01': { icon: 'ğŸŒ¤ï¸', location: 'æ±äº¬', tempHigh: '9Â°', tempLow: '2Â°' },
            '2026-01-02': { icon: 'ğŸŒ¤ï¸', location: 'æ±äº¬', tempHigh: '8Â°', tempLow: '3Â°' },
            '2026-01-03': { icon: 'â˜ï¸', location: 'æ±äº¬', tempHigh: '8Â°', tempLow: '3Â°' }
          },
          dayNotes: {},
          selectedDate: '2025-12-28',
          expenseSelectedDate: '',
          schedules: [],
          showScheduleModal: false,
          editingSchedule: null,
          expenses: [],
          newExpense: {
            amount: null,
            currency: '',
            paidBy: '',
            category: '',
            date: '',
            note: ''
          },
          editingExpenseIndex: null,
          todos: [],
          newTodoText: ''
        };
      },
      computed: {
        todayString() {
          const d = new Date();
          const y = d.getFullYear();
          const m = (d.getMonth() + 1).toString().padStart(2, '0');
          const day = d.getDate().toString().padStart(2, '0');
          return `${y}-${m}-${day}`;
        },
        dayHeaderTitle() {
          const day = this.tripDays.find(d => d.dateKey === this.selectedDate);
          if (!day) return this.selectedDate;
          return `${day.label} (${day.weekday})`;
        },
        currentWeather() {
          return this.weatherByDate[this.selectedDate] || {};
        },
        sortedSchedulesForSelected() {
          const list = this.schedules.filter(s => s.date === this.selectedDate);
          return list.sort((a, b) => {
            const ta = a.time || '24:59';
            const tb = b.time || '24:59';
            return ta.localeCompare(tb);
          });
        },
        canAddExpense() {
          return this.newExpense.amount &&
                 this.newExpense.currency &&
                 this.newExpense.paidBy &&
                 this.newExpense.category;
        },
        filteredExpenses() {
          if (!this.expenseSelectedDate) return this.expenses;
          return this.expenses.filter(e => e.date === this.expenseSelectedDate);
        },
        totalExpenseHKD() {
          return this.expenses.reduce((sum, e) => {
            if (!e.amount) return sum;
            const base = e.currency === 'JPY' ? e.amount * this.jpyRate : e.amount;
            return sum + base;
          }, 0);
        },
        kennethTotalHKD() {
          return this.expenses.reduce((sum, e) => {
            if (e.paidBy !== 'kenneth') return sum;
            const base = e.currency === 'JPY' ? e.amount * this.jpyRate : e.amount;
            return sum + base;
          }, 0);
        },
        biancaTotalHKD() {
          return this.expenses.reduce((sum, e) => {
            if (e.paidBy !== 'bianca') return sum;
            const base = e.currency === 'JPY' ? e.amount * this.jpyRate : e.amount;
            return sum + base;
          }, 0);
        }
      },
      mounted() {
        schedulesColRef
          .orderBy('date')
          .orderBy('time')
          .onSnapshot(snapshot => {
            const list = [];
            snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
            this.schedules = list;
          });

        expensesColRef
          .orderBy('createdAt', 'asc')
          .onSnapshot(snapshot => {
            const list = [];
            snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
            this.expenses = list;
          });

        todosColRef
          .orderBy('createdAt', 'asc')
          .onSnapshot(snapshot => {
            const list = [];
            snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
            this.todos = list;
          });

        dayNotesColRef
          .onSnapshot(snapshot => {
            const map = {};
            snapshot.forEach(doc => {
              const d = doc.data();
              map[d.dateKey] = d.description || '';
            });
            this.dayNotes = map;
          });
      },
      methods: {
        formattedTime(t) {
          return t || '--:--';
        },
        timePeriodLabel(t) {
          if (!t) return 'æœªè¨­å®š';
          const [h] = t.split(':').map(Number);
          if (h < 12) return 'ä¸Šåˆ';
          if (h < 18) return 'ä¸‹åˆ';
          return 'æ™šä¸Š';
        },

        async updateDayDescription(text) {
          const dateKey = this.selectedDate;
          if (!dateKey) return;

          this.dayNotes = {
            ...this.dayNotes,
            [dateKey]: text
          };

          await dayNotesColRef.doc(dateKey).set(
            {
              dateKey,
              description: text
            },
            { merge: true }
          );
        },

        // è¡Œç¨‹
        openNewSchedule() {
          this.editingSchedule = {
            id: null,
            date: this.selectedDate,
            time: '',
            location: '',
            mapUrl: '',
            note: '',
            category: ''
          };
          this.showScheduleModal = true;
        },
        openEditSchedule(item) {
          this.editingSchedule = { ...item };
          this.showScheduleModal = true;
        },
        closeScheduleModal() {
          this.showScheduleModal = false;
          this.editingSchedule = null;
        },
        async saveSchedule() {
          if (!this.editingSchedule.date) return;

          const payload = {
            date: this.editingSchedule.date,
            time: this.editingSchedule.time || '',
            location: this.editingSchedule.location || '',
            mapUrl: this.editingSchedule.mapUrl || '',
            note: this.editingSchedule.note || '',
            category: this.editingSchedule.category || '',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          if (!this.editingSchedule.id) {
            await schedulesColRef.add({
              ...payload,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            await schedulesColRef.doc(this.editingSchedule.id).update(payload);
          }

          this.selectedDate = this.editingSchedule.date;
          this.closeScheduleModal();
        },
        async deleteSchedule(id) {
          if (!id) return;
          await schedulesColRef.doc(id).delete();
          this.closeScheduleModal();
        },
        updateScheduleCategory(id, category) {
          if (!id) return;
          schedulesColRef.doc(id).update({ category: category || '' });
        },
        openInMapsByQuery(query) {
          if (!query) return;
          const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
          window.open(url, '_blank');
        },
        openMapUrl(url) {
          if (!url) return;
          window.open(url, '_blank');
        },

        // è¨˜å¸³
        startEditExpense(index) {
          const exp = this.filteredExpenses[index];
          if (!exp) return;
          const { id, createdAt, ...rest } = exp;
          this.newExpense = { ...rest };
          this.editingExpenseIndex = index;
          this.activeTab = 'expense';
        },
        async addExpense() {
          if (!this.canAddExpense) return;

          const autoDate = this.expenseSelectedDate || this.selectedDate || this.todayString;
          const payload = {
            amount: Number(this.newExpense.amount),
            currency: this.newExpense.currency,
            paidBy: this.newExpense.paidBy,
            category: this.newExpense.category,
            note: this.newExpense.note || '',
            date: this.newExpense.date || autoDate,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          if (this.editingExpenseIndex !== null) {
            const exp = this.filteredExpenses[this.editingExpenseIndex];
            if (exp && exp.id) {
              await expensesColRef.doc(exp.id).update(payload);
            }
          } else {
            await expensesColRef.add(payload);
          }

          this.newExpense = {
            amount: null,
            currency: '',
            paidBy: '',
            category: '',
            date: '',
            note: ''
          };
          this.editingExpenseIndex = null;
        },
        async removeExpense(index) {
          const exp = this.filteredExpenses[index];
          if (!exp || !exp.id) return;
          await expensesColRef.doc(exp.id).delete();

          if (this.editingExpenseIndex === index) {
            this.editingExpenseIndex = null;
            this.newExpense = {
              amount: null,
              currency: '',
              paidBy: '',
              category: '',
              date: '',
              note: ''
            };
          }
        },

        // æ¸…å–®
        async addTodo() {
          if (!this.newTodoText) return;
          await todosColRef.add({
            text: this.newTodoText,
            done: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          this.newTodoText = '';
        },
        async removeTodo(index) {
          const item = this.todos[index];
          if (!item || !item.id) return;
          await todosColRef.doc(item.id).delete();
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
